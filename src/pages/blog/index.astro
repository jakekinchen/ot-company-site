---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Layout from '../../components/Layout.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import FormattedDate from '../../components/FormattedDate.astro';
import type { PostItem } from '../../types';
import { GET_POST, GET_POST_ITEMS } from '../../queries';  // Update the import path as necessary


async function getPosts() {
  try {
    console.log('Fetching posts...');
    const res = await fetch('https://onetier.com/graphql', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        query: GET_POST_ITEMS,
      }),
    });

    if (!res.ok) {
      console.error('Failed to fetch data:', res.statusText, "Entire response:", res);
      return [];
    }

    const jsonData = await res.json();

    if (!jsonData.data || !jsonData.data.posts || !jsonData.data.posts.nodes) {
      console.error('Unexpected API response structure:', res);
      return [];
    }

    const posts = jsonData.data.posts.nodes;
    //console.log('Fetched posts:', posts);
	console.log("Posts fetched successfully");
    return posts;
  } catch (error) {
    console.error('Error fetching posts:', error);
    return [];
  }
}

  const posts = await getPosts();

  const metadata = {
	title: SITE_TITLE,
	description: SITE_DESCRIPTION,
  };

  const gradient = true;


---

<Layout headerLogoColor='blue' headerIconColor='blue' headerBackground='bg-white' gradient={true}>
			<section>
				<ul>
					{
						posts.map((post:PostItem) => (
							<li>
								<a href={`/blog/${post.slug}/`}>
									<img width={720} height={360} src={post.featuredImage?.node?.sourceUrl || '/placeholder-image.jpg'} alt="" />
									<h4 class="title">{post.title}</h4>
									<p class="date">
										<FormattedDate date={new Date(post.date)} />
									</p>
								</a>
							</li>
						))
					}
				</ul>
			</section>
		</Layout>
