---
import BlogPost from '../../layouts/BlogPost.astro';
import type { Post } from '../../types';
import { GET_POST } from '../../queries';

export async function getStaticPaths() {
  try {
    // Fetch data from your WordPress GraphQL API
    const res = await fetch('https://onetier.com/graphql', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        query: GET_POST,
      }),
    });

    if (!res.ok) {
      console.error('Failed to fetch data:', res.statusText);
      return [];
    }

    const { data } = await res.json();

    if (!data || !data.posts || !data.posts.nodes) {
      console.error('Unexpected API response structure:', data);
      return [];
    }

    const posts: Post[] = data.posts.nodes;

    return posts.map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
  } catch (error) {
    console.error('Error in getStaticPaths:', error);
    return [];
  }
}

const { post }: { post: Post } = Astro.props;

// Rendering the content with Astro components
---

<BlogPost 
  title={post.title}
  date={new Date(post.date)}
  author={post.author.node.map(author => author.name).join(', ')}
>
<div class="content" {...({ dangerouslySetInnerHTML: { __html: post.content } } as any)} />
</BlogPost>